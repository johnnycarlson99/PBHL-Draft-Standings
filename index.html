<!DOCTYPE html>
<html>
<head>
<title>December Draft Standings</title>
<meta charset="UTF-8">
<style>
  body {
    background: #111;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
  }
  table {
    margin: auto;
    border-collapse: collapse;
    width: 90%;
    font-size: 22px;
  }
  th, td {
    padding: 12px;
    border-bottom: 1px solid #444;
  }
  tr:nth-child(even) { background:#222; }
  th { color:#0af; }
  #error { color: red; margin-top: 20px; }
</style>
</head>
<body>

<h1>December Roller Draft Standings</h1>
<p>(Auto-updates every 60 seconds)</p>

<div id="error"></div>

<table id="standings">
  <tr>
    <th>Rank</th><th>Captain</th><th>Team</th>
    <th>W</th><th>L</th><th>OTL</th><th>Points</th><th>Pts%</th>
  </tr>
</table>

<script>
// Captain â†’ NHL Team ID mapping
const TEAM_MAP = {
  "Johnny": { id: 3, name: "Rangers" },
  "Dan":    { id: 16, name: "Blackhawks" },
  "Grant":  { id: 17, name: "Red Wings" },
  "Ethan":  { id: 54, name: "Vegas" },
  "Mikey":  { id: 19, name: "Blues" },
  "Chris":  { id: 5,  name: "Penguins" },
  "Gage":   { id: 6,  name: "Bruins" },
  "Daz":    { id: 28, name: "Sharks" }
};

// 100% working proxy
async function fetchNHLData() {
  const year = 2024;
  const apiUrl = `https://statsapi.web.nhl.com/api/v1/schedule?startDate=${year}-12-01&endDate=${year}-12-31`;

  const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(apiUrl);

  try {
    const response = await fetch(proxyUrl);
    const wrapped = await response.json();
    return JSON.parse(wrapped.contents).dates || [];
  } catch (err) {
    document.getElementById("error").innerText = "Error loading NHL data.";
    console.error(err);
    return [];
  }
}

async function computeStandings() {
  const games = await fetchNHLData();

  let standings = {};
  for (let captain in TEAM_MAP) {
    standings[captain] = {
      captain,
      team: TEAM_MAP[captain].name,
      id: TEAM_MAP[captain].id,
      W: 0, L: 0, OTL: 0, Points: 0, Games: 0
    };
  }

  games.forEach(day => {
    day.games.forEach(game => {
      if (game.status.detailedState !== "Final") return;

      let home = game.teams.home;
      let away = game.teams.away;

      let H = home.team.id;
      let A = away.team.id;

      let homeScore = home.score;
      let awayScore = away.score;

      let wentOT = game.linescore.currentPeriod > 3 || game.linescore.hasShootout;

      for (let captain in standings) {
        let teamId = standings[captain].id;

        if (teamId === H || teamId === A) {
          let winner = homeScore > awayScore ? H : A;
          let loser = homeScore > awayScore ? A : H;

          if (teamId === winner) {
            standings[captain].W++;
            standings[captain].Points += 2;
          } else if (teamId === loser) {
            if (wentOT) {
              standings[captain].OTL++;
              standings[captain].Points++;
            } else {
              standings[captain].L++;
            }
          }
        }
      }
    });
  });

  for (let c in standings) {
    let s = standings[c];
    s.Games = s.W + s.L + s.OTL;
    s.PtsPct = s.Games ? s.Points / (s.Games * 2) : 0;
  }

  return standings;
}

async function renderStandings() {
  let standings = await computeStandings();

  if (!standings) {
    document.getElementById("error").innerText = "Standings unavailable.";
    return;
  }

  let rows = Object.values(standings).sort((a,b) => b.PtsPct - a.PtsPct);

  let table = document.getElementById("standings");
  table.innerHTML = `
    <tr>
      <th>Rank</th><th>Captain</th><th>Team</th>
      <th>W</th><th>L</th><th>OTL</th>
      <th>Points</th><th>Pts%</th>
    </tr>
  `;

  rows.forEach((s, i) => {
    table.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${s.captain}</td>
        <td>${s.team}</td>
        <td>${s.W}</td>
        <td>${s.L}</td>
        <td>${s.OTL}</td>
        <td>${s.Points}</td>
        <td>${(s.PtsPct*100).toFixed(1)}%</td>
      </tr>
    `;
  });
}

renderStandings();
setInterval(renderStandings, 60000);
</script>

</body>
</html>
